/* XDomain - v0.4.3 - https://github.com/jpillora/xdomain - Jaime Pillora <dev@jpillora.com> - MIT Copyright 2013 */ !function(a,b){!function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p=[].slice;e=["open","setRequestHeader","send","abort","getAllResponseHeaders","getResponseHeader","overrideMimeType"],d=["readystatechange","progress","loadstart","loadend","load","error","abort"],f=["readyState","responseText","withCredentials","statusText","status","response","responseType","responseXML","upload"],g=f[0],h=f[1],i=f[2],k=function(a){var b;return b=function(){},b.prototype=a,new b},o=[],n=function(a,b){return null==b&&(b=o.length),o.splice(b,0,a)},j=function(a,b){var c,d,e,f,g,h;switch(null==b&&(b={}),typeof a){case"object":d=[];for(e in a)f=a[e],d.push(""+e+":  "+f);return d.join("\n");case"string":for(d=a.split("\n"),g=0,h=d.length;h>g;g++)c=d[g],/([^:]+):\s*(.+)/.test(c)&&(b[RegExp.$1]||(b[RegExp.$1]=RegExp.$2));return b}},n.headers=j,n.PROPS=f,l=function(b){var c;return(c=a[b])?a[b]=function(a){return"string"!=typeof a||/\.XMLHTTP/.test(a)?m(new c(a),c):void 0}:void 0},l("ActiveXObject"),l("XMLHttpRequest"),m=function(a){var b,h,l,m,n,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J;if(0===o.length)return a;for(C={},B={},B[i]=!1,r={},s={},l={},m={},h=function(b){var c,d,e,f;c={},f=b||{};for(d in f)e=f[d],c[d]=e===a?B:e;return c},B.addEventListener=function(a,b){return(m[a]=m[a]||[]).push(b)},B.removeEventListener=function(a,b){var c,d,e,f,g,h;for(d=-1,h=m[a]||[],e=f=0,g=h.length;g>f;e=++f)c=h[e],c===b&&(d=e);return-1!==d?m[a].splice(d,1):void 0},B.dispatchEvent=function(a){return v.trigger(a)},v=k(l),A={},v.set=function(b,c){var d;if(A[b]=1,b===g){for(d=[];B[g]<c;)B[g]++,B[g]!==a[g]&&(v.trigger("readystatechange"),1===B[g]&&v.trigger("loadstart"),4===B[g]?(v.trigger("load"),d.push(v.trigger("loadend"))):d.push(void 0));return d}return B[b]=c},y=k(r),v.setRequestHeader=function(b,c){return y[b]=c,l.opened?a.setRequestHeader(b,c):void 0},z=k(s),v.setResponseHeader=function(a,b){return z[a]=b},x={},w={},v.onChange=function(a,b){return(x[a]=x[a]||[]).push(b)},v.onCall=function(a,b){return(w[a]=w[a]||[]).push(b)},v.trigger=function(a,b){var c,d,e,f,g;for(null==b&&(b={}),a=a.replace(/^on/,""),b.type=a,null!=(f=B["on"+a])&&f.call(B,b),g=m[a]||[],d=0,e=g.length;e>d;d++)c=g[d],c.call(B,b)},v.serialize=function(){var a,b,c,d,e,g,h,i;for(c={},h=0,i=f.length;i>h;h++)b=f[h],c[b]=B[b];e={};for(a in z)g=z[a],e[a]=g;d={};for(a in y)g=y[a],d[a]=g;return{method:l.method,url:l.url,async:l.async,body:l.body,responseHeaders:e,requestHeaders:d,props:c}},v.deserialize=function(a){var b,c,d,e,f,g,h,i,j,k;for(h=["method","url","async","body"],f=0,g=h.length;g>f;f++)c=h[f],a[c]&&(v[c]=a[c]);i=a.responseHeaders||{};for(b in i)e=i[b],v.setResponseHeader(b,e);j=a.requestHeaders||{};for(b in j)e=j[b],v.setRequestHeader(b,e);k=a.props||{};for(d in k)e=k[d],v.set(d,e)},E=0,H=e.length;H>E;E++)q=e[E],a[q]&&function(b){return B[b]=function(){var d,e,f,g,h,i,k;switch(d=1<=arguments.length?p.call(arguments,0):[],l.opened=!l.opened&&"open"===b,l.sent=!l.sent&&"send"===b,b){case"getAllResponseHeaders":return j(z);case"send":l.body=d[0];break;case"open":l.method=d[0],l.url=d[1],l.async=d[2]}for(g=d,f=w[b]||[],i=0,k=f.length;k>i;i++){if(e=f[i],h=e(d),h===!1)return;h&&(g=h)}if("setRequestHeader"===b){if(r[g[0]]=g[1],y[d[0]]!==c)return}else if("getRequestHeader"===b)return z[g[0]];return a[b]?a[b].apply(a,g):void 0}}(q);for(t=function(){var b,c,d,e,g;try{for(g=[],d=0,e=f.length;e>d;d++)c=f[d],g.push(u(c,a[c]));return g}catch(h){if(b=h,"TypeError"===b.constructor.name)throw b}},u=function(b,d){var e,f,h,i,k,m,n,o,p;if(k=C[b],d!==k){if(C[b]=d,b===g){if(1===d)for(h in y)n=y[h],a.setRequestHeader(h,n);2===d&&(l.statusCode=a.status,j(a.getAllResponseHeaders(),s))}for(f=x[b]||[],o=0,p=f.length;p>o;o++)e=f[o],m=e(d,k),m!==c&&(i=m);if(!A[b])return B[b]=i===c?d:i}},D=function(b){return a[b]=function(a){return t(),v.trigger(b,h(a))}},F=0,I=d.length;I>F;F++)n=d[F],D("on"+n);for(t(),G=0,J=o.length;J>G;G++)b=o[G],b.call(null,v);return B},a.xhook=n}(a,b);var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;for(e=location.protocol+"//"+location.host,s=function(a){return a="xdomain ("+e+"): "+a,console.warn?console.warn(a):alert(a)},x=["postMessage","JSON"],t=0,v=x.length;v>t;t++)if(f=x[t],!a[f])return s("requires '"+f+"' and this browser does not support it"),void 0;for(d="XPING",h=function(){return(Math.random()*Math.pow(2,32)).toString(16)},l=function(a){return/(https?:\/\/[^\/]+)(\/.*)?/.test(a)?{origin:RegExp.$1,path:RegExp.$2}:null},r=function(a){var b;return a instanceof RegExp?a:(b=a.toString().replace(/\W/g,function(a){return"\\"+a}).replace(/\\\*/g,".+"),new RegExp("^"+b+"$"))},j=function(c){return b.addEventListener?a.addEventListener("message",c):a.attachEvent("onmessage",c)},n=function(a){return JSON.stringify(a)},g=function(a){return JSON.parse(a)},p=function(b){return j(function(a){var c,d,e,f,h,i,j,k,m,o,p,q,t;i=a.origin,k=null;for(e in b){o=b[e];try{if(f=r(e),f.test(i)){k=r(o);break}}catch(u){}}if(!k)return s("blocked request from: '"+i+"'"),void 0;if(c=a.source,h=g(a.data),p=h.req,j=l(p.url),!j||!k.test(j.path))return s("blocked request to path: '"+j.path+"' by regex: "+o),void 0;m=new XMLHttpRequest,m.open(p.method,p.url),m.onreadystatechange=function(){var a,b,d,e;if(4===m.readyState){for(b={props:{}},e=xhook.PROPS,d=e.length-1;d>=0;d+=-1)j=e[d],"responseXML"!==j&&(b.props[j]=m[j]);return b.responseHeaders=xhook.headers(m.getAllResponseHeaders()),a=n({id:h.id,res:b}),c.postMessage(a,i)}},t=p.requestHeaders;for(d in t)q=t[d],m.setRequestHeader(d,q);return m.send(p.body||null)}),a===a.parent?s("slaves must be in an iframe"):a.parent.postMessage(d,"*")},o=function(a){return j(function(a){var b;return null!=(b=c.prototype.frames[a.origin])?b.recieve(a):void 0}),xhook(function(b){return b.onCall("open",function(c){var d;return d=l(c[1]),d&&a[d.origin]?(c[2]===!1&&s("sync not supported"),setTimeout(function(){return b.set("readyState",1)}),!1):void 0}),b.onCall("send",function(){var d,e;return e=l(b.url),e&&a[e.origin]?(d=new c(e.origin,a[e.origin]),d.send(b.serialize(),function(a){return b.deserialize(a)}),!1):void 0})})},c=function(){function a(a,c){return this.origin=a,this.proxyPath=c,this.frames[this.origin]?this.frames[this.origin]:(this.frames[this.origin]=this,this.listeners={},this.frame=b.createElement("iframe"),this.frame.id=this.frame.name="xdomain-"+h(),this.frame.src=this.origin+this.proxyPath,this.frame.setAttribute("style","display:none;"),b.body.appendChild(this.frame),this.waits=0,this.ready=!1,void 0)}return a.prototype.frames={},a.prototype.post=function(a){return this.frame.contentWindow.postMessage(a,this.origin)},a.prototype.listen=function(a,b){if(this.listeners[a])throw"already listening for: "+a;return this.listeners[a]=b},a.prototype.unlisten=function(a){return delete this.listeners[a]},a.prototype.recieve=function(a){var b,c;return a.data===d?(this.ready=!0,void 0):(c=g(a.data),(b=this.listeners[c.id])?(this.unlisten(c.id),b(c.res)):(s("unkown message ("+c.id+")"),void 0))},a.prototype.send=function(a,b){var c=this;return this.readyCheck(function(){var d;return d=h(),c.listen(d,function(a){return b(a)}),c.post(n({id:d,req:a}))})},a.prototype.readyCheck=function(a){var b=this;if(this.ready===!0)return a();if(this.waits++>=100)throw"Timeout connecting to iframe: "+this.origin;return setTimeout(function(){return b.readyCheck(a)},100)},a}(),a.xdomain=function(a){a&&(a.masters&&p(a.masters),a.slaves&&o(a.slaves))},xdomain.origin=e,y=b.getElementsByTagName("script"),u=0,w=y.length;w>u;u++)if(m=y[u],/xdomain/.test(m.src)){if(m.hasAttribute("slave")){if(k=l(m.getAttribute("slave")),!k)return;q={},q[k.origin]=k.path,xdomain({slaves:q})}m.hasAttribute("master")&&(i={},i[m.getAttribute("master")]=/./,xdomain({masters:i}))}}(window,document);